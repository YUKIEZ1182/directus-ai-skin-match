<template>
    <private-view title="Product Import">
        <div class="import-container">
            <div class="setup-panel">
                <v-sheet class="main-card">
                    <div class="card-header">
                        <v-icon name="cloud_upload" size="large" color="var(--primary)" />
                        <h2>‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
                        <p>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå Excel (.csv) ‡πÅ‡∏•‡∏∞‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</p>
                    </div>

                    <v-divider class="my-24" />

                    <section class="step-section">
                        <div class="step-badge">1</div>
                        <div class="step-content">
                            <div class="step-header">
                                <div class="step-title">‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• CSV</div>
                                <v-button icon secondary x-small @click="showGuide = true"
                                    v-tooltip="'‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏Å‡πÅ‡∏ï‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° HTML ‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ü‡∏¥‡∏•‡∏î‡πå'">
                                    <v-icon name="help_outline" />
                                </v-button>
                            </div>
                            <p class="step-desc">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡πÉ‡∏ô Excel ‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô .csv (UTF-8)</p>

                            <div class="download-card mt-12" @click="downloadTemplate">
                                <div class="download-icon-box">
                                    <v-icon name="download" />
                                </div>
                                <div class="download-info">
                                    <div class="main-text">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î CSV Template</div>
                                    <div class="sub-text">‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏Å‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏¢‡∏∑‡πâ‡∏≠‡∏á‡πÑ‡∏ß‡πâ‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <v-divider class="my-24" />

                    <section class="step-section">
                        <div class="step-badge">2</div>
                        <div class="step-content">
                            <div class="step-title">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</div>
                            <div class="file-zone mt-12">
                                <input type="file" @change="onCSVSelect" accept=".csv" id="csv-input" class="hidden" />
                                <label for="csv-input" :class="['drop-label', { 'has-file': csvFile }]">
                                    <v-icon :name="csvFile ? 'insert_drive_file' : 'post_add'" left />
                                    {{ csvFile ? csvFile.name : '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå .csv ‡∏ó‡∏µ‡πà‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÑ‡∏ß‡πâ' }}
                                </label>
                            </div>
                        </div>
                    </section>

                    <v-divider class="my-24" />

                    <section class="step-section">
                        <div class="step-badge">3</div>
                        <div class="step-content">
                            <div class="step-title">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö</div>
                            <p class="step-desc">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ß‡πâ‡πÉ‡∏ô CSV (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ)</p>
                            <div class="file-zone mt-12">
                                <input type="file" multiple @change="onImagesSelect" accept="image/*" id="img-input"
                                    class="hidden" />
                                <label for="img-input" :class="['drop-label', { 'has-file': localImages.length }]">
                                    <v-icon :name="localImages.length ? 'photo_library' : 'add_photo_alternate'" left />
                                    {{ localImages.length ? `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÅ‡∏•‡πâ‡∏ß ${localImages.length} ‡πÑ‡∏ü‡∏•‡πå` :
                                        '‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û' }}
                                </label>
                            </div>
                        </div>
                    </section>

                    <v-divider class="my-24" />

                    <v-button :loading="isProcessing" :disabled="!csvFile" @click="startImport" kind="primary" block
                        size="large">
                        <v-icon name="upload" left /> ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    </v-button>
                </v-sheet>
            </div>

            <div class="log-panel">
                <div class="console-box">
                    <div class="console-header">
                        <div class="header-left">
                            <v-icon name="terminal" left small />
                            <span>Live Import Logs</span>
                        </div>
                        <v-chip v-if="isProcessing" x-small color="var(--primary)" animate>EXECUTING</v-chip>
                    </div>
                    <div class="console-content" ref="logContainer">
                        <div v-if="logs.length === 0" class="empty-log">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...</div>
                        <div v-for="(log, i) in logs" :key="i" :class="['log-entry', log.type]">
                            <span class="t">{{ log.time }}</span>
                            <span class="m">{{ log.msg }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <v-dialog v-model="showGuide" @esc="showGuide = false" size="xl">
                <v-card class="guide-dialog-card">
                    <v-card-title>CSV Column Guide & HTML Decorator</v-card-title>
                    <v-card-text class="scrollable-content">

                        <div class="html-cheat-sheet mb-24">
                            <h4>üé® ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ï‡∏Å‡πÅ‡∏ï‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô Description (‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô Excel ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢)</h4>
                            <table class="cheat-table">
                                <thead>
                                    <tr>
                                        <th style="width: 200px">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</th>
                                        <th>‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ô Excel</th>
                                        <th>‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><strong>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏≤</strong></td>
                                        <td><code>&lt;b&gt;‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°&lt;/b&gt;</code></td>
                                        <td>‡πÄ‡∏ô‡πâ‡∏ô‡∏Ñ‡∏≥‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <h3 style="margin:0; color:var(--primary)">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà</h3>
                                        </td>
                                        <td><code>&lt;h3&gt;‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠&lt;/h3&gt;</code></td>
                                        <td>‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å (H3)</td>
                                    </tr>
                                    <tr>
                                        <td><span style="color: red">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏µ‡πÅ‡∏î‡∏á</span></td>
                                        <td><code>&lt;span style="color:red"&gt;‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°&lt;/span&gt;</code></td>
                                        <td>‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô red ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏≠‡∏∑‡πà‡∏ô‡πÑ‡∏î‡πâ</td>
                                    </tr>
                                    <tr>
                                        <td>‚Ä¢ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ 1<br>‚Ä¢ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ 2</td>
                                        <td><code>&lt;ul&gt;&lt;li&gt;‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ 1&lt;/li&gt;&lt;li&gt;‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ 2&lt;/li&gt;&lt;/ul&gt;</code>
                                        </td>
                                        <td>‡∏ó‡∏≥‡∏à‡∏∏‡∏î Bullet point</td>
                                    </tr>
                                    <tr>
                                        <td><u>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏µ‡∏î‡πÄ‡∏™‡πâ‡∏ô‡πÉ‡∏ï‡πâ</u></td>
                                        <td><code>&lt;u&gt;‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°&lt;/u&gt;</code></td>
                                        <td>‡πÉ‡∏ä‡πâ‡∏Ç‡∏µ‡∏î‡πÄ‡∏™‡πâ‡∏ô‡πÉ‡∏ï‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</td>
                                    </tr>
                                </tbody>
                            </table>
                            <div class="html-helper-box mt-12">
                                <p>üí° <strong>‡πÄ‡∏Ñ‡∏•‡πá‡∏î‡∏•‡∏±‡∏ö:</strong> ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏•‡∏¢ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏õ‡∏•‡∏á‡∏Å‡∏≤‡∏£ <b>"‡πÄ‡∏ß‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î"</b> ‡πÉ‡∏ô
                                    Excel ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏£‡∏±‡∏ö</p>
                            </div>
                        </div>

                        <table class="guide-table">
                            <thead>
                                <tr>
                                    <th style="width: 150px">‡∏´‡∏±‡∏ß‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå</th>
                                    <th>‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢</th>
                                    <th style="width: 250px">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>name</strong></td>
                                    <td>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô)</td>
                                    <td>Nivea Moisturizing Cream</td>
                                </tr>
                                <tr>
                                    <td><strong>brand_name</strong></td>
                                    <td>‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</td>
                                    <td>Nivea</td>
                                </tr>
                                <tr>
                                    <td><strong>ingredients</strong></td>
                                    <td>‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡πà‡∏ß‡∏ô‡∏ú‡∏™‡∏° ‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏≠‡∏°‡∏°‡∏≤ (,)</td>
                                    <td>Aqua, Glycerin</td>
                                </tr>
                                <tr>
                                    <td><strong>thumbnail</strong></td>
                                    <td>‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏õ‡∏Å ‡∏´‡∏£‡∏∑‡∏≠ URL</td>
                                    <td>nivea_cover.jpg</td>
                                </tr>
                                <tr>
                                    <td><strong>illustrations</strong></td>
                                    <td>‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏≠‡∏°‡∏°‡∏≤ (,)</td>
                                    <td>p1.jpg, p2.jpg</td>
                                </tr>
                                <tr>
                                    <td><strong>price</strong></td>
                                    <td>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)</td>
                                    <td>1250</td>
                                </tr>
                                <tr>
                                    <td><strong>quantity</strong></td>
                                    <td>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</td>
                                    <td>50</td>
                                </tr>
                                <tr>
                                    <td><strong>skin_types</strong></td>
                                    <td>‡∏û‡∏¥‡∏°‡∏û‡πå‡πÑ‡∏ó‡∏¢: ‡∏ú‡∏¥‡∏ß‡∏°‡∏±‡∏ô, ‡∏ú‡∏¥‡∏ß‡πÅ‡∏´‡πâ‡∏á, ‡∏ú‡∏¥‡∏ß‡∏ú‡∏™‡∏°, ‡∏ú‡∏¥‡∏ß‡πÅ‡∏û‡πâ‡∏á‡πà‡∏≤‡∏¢</td>
                                    <td>‡∏ú‡∏¥‡∏ß‡∏°‡∏±‡∏ô, ‡∏ú‡∏¥‡∏ß‡πÅ‡∏´‡πâ‡∏á</td>
                                </tr>
                                <tr>
                                    <td><strong>categories</strong></td>
                                    <td>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÑ‡∏ó‡∏¢ (‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)</td>
                                    <td>‡∏°‡∏≠‡∏¢‡∏™‡πå‡πÄ‡∏à‡∏≠‡∏£‡πå‡πÑ‡∏£‡πÄ‡∏ã‡∏≠‡∏£‡πå, ‡∏Ñ‡∏£‡∏µ‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏ú‡∏¥‡∏ß</td>
                                </tr>
                                <tr>
                                    <td><strong>description</strong></td>
                                    <td>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (‡πÉ‡∏™‡πà HTML ‡∏´‡∏£‡∏∑‡∏≠ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏î‡πâ)</td>
                                    <td>&lt;h3&gt;‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥&lt;/h3&gt;...</td>
                                </tr>
                                <tr>
                                    <td><strong>status</strong></td>
                                    <td>active / inactive</td>
                                    <td>active</td>
                                </tr>
                            </tbody>
                        </table>
                    </v-card-text>
                    <v-card-actions>
                        <v-spacer />
                        <v-button kind="primary" @click="showGuide = false">
                            ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÅ‡∏•‡πâ‡∏ß
                        </v-button>
                    </v-card-actions>
                </v-card>
            </v-dialog>
        </div>
    </private-view>
</template>

<script>
import { ref, nextTick } from 'vue';
import { useApi } from '@directus/extensions-sdk';
import Papa from 'papaparse';

export default {
    setup() {
        const api = useApi();
        const csvFile = ref(null);
        const localImages = ref([]);
        const isProcessing = ref(false);
        const showGuide = ref(false);
        const logs = ref([]);
        const logContainer = ref(null);

        const onCSVSelect = (e) => csvFile.value = e.target.files[0];
        const onImagesSelect = (e) => localImages.value = Array.from(e.target.files);

        const addLog = (msg, type = 'info') => {
            const time = new Date().toLocaleTimeString('th-TH', { hour12: false });
            logs.value.push({ time, msg, type });
            nextTick(() => {
                if (logContainer.value) logContainer.value.scrollTop = logContainer.value.scrollHeight;
            });
        };

        const formatDescription = (text) => {
            if (!text) return '';
            if (/<[a-z][\s\S]*>/i.test(text)) return text;
            return text.split(/\n\n+/).map(p => `<p>${p.replace(/\n/g, '<br>')}</p>`).join('');
        };

        const mapSkinType = (thaiString) => {
            if (!thaiString) return [];
            const mapping = { '‡∏ú‡∏¥‡∏ß‡∏°‡∏±‡∏ô': 'oily', '‡∏ú‡∏¥‡∏ß‡πÅ‡∏´‡πâ‡∏á': 'dry', '‡∏ú‡∏¥‡∏ß‡∏ú‡∏™‡∏°': 'combination', '‡∏ú‡∏¥‡∏ß‡πÅ‡∏û‡πâ‡∏á‡πà‡∏≤‡∏¢': 'sensitive' };
            return thaiString.split(',').map(s => s.trim()).map(s => mapping[s] || s).filter(s => ['oily', 'dry', 'combination', 'sensitive'].includes(s));
        };

        const getCategoryPayload = async (catString) => {
            if (!catString) return [];
            const names = catString.split(',').map(n => n.trim()).filter(n => n);
            const payload = [];
            for (const name of names) {
                const res = await api.get('/items/category', { params: { filter: { name: { _eq: name } }, limit: 1 } });
                let catId = res.data.data[0]?.id || (await api.post('/items/category', { name })).data.data.id;
                payload.push({ category_id: { id: catId } });
            }
            return payload;
        };

        const downloadTemplate = () => {
            const headers = ['name', 'brand_name', 'ingredients', 'thumbnail', 'illustrations', 'price', 'quantity', 'skin_types', 'categories', 'description', 'status'];
            const sampleData = [
                'Nivea Moisturizing Cream',
                'Nivea',
                'Aqua, Glycerin',
                'nivea_cover.jpg',
                'p1.jpg, p2.jpg',
                '1250',
                '50',
                '‡∏ú‡∏¥‡∏ß‡∏°‡∏±‡∏ô, ‡∏ú‡∏¥‡∏ß‡πÅ‡∏´‡πâ‡∏á',
                '‡∏°‡∏≠‡∏¢‡∏™‡πå‡πÄ‡∏à‡∏≠‡∏£‡πå‡πÑ‡∏£‡πÄ‡∏ã‡∏≠‡∏£‡πå, ‡∏Ñ‡∏£‡∏µ‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏ú‡∏¥‡∏ß',
                '<h3>‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥</h3><p>‡∏Ñ‡∏£‡∏µ‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏ú‡∏¥‡∏ß‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∏‡πà‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏¢‡∏≤‡∏ß‡∏ô‡∏≤‡∏ô</p>',
                'active'
            ];

            const wrap = (val) => `"${String(val).replace(/"/g, '""')}"`;
            const csvContent = [
                headers.map(wrap).join(","),
                sampleData.map(wrap).join(",")
            ].join("\n");

            const blob = new Blob([`\ufeff${csvContent}`], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.setAttribute("download", "product_template.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        async function getFileId(source) {
            if (!source) return null;
            const src = source.trim();
            const localMatch = localImages.value.find(f => f.name === src);
            if (localMatch) {
                const formData = new FormData();
                formData.append('file', localMatch);
                return (await api.post('/files', formData)).data.data.id;
            }
            if (src.startsWith('http')) return (await api.post('/files/import', { url: src })).data.data.id;
            return (await api.get('/files', { params: { filter: { filename_download: { _eq: src } }, limit: 1 } })).data.data[0]?.id || null;
        }

        const startImport = () => {
            isProcessing.value = true;
            logs.value = [];
            Papa.parse(csvFile.value, {
                header: true,
                skipEmptyLines: true,
                complete: async (results) => {
                    for (const row of results.data) {
                        try {
                            addLog(`‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•: ${row.name}`);
                            
                            const existingRes = await api.get('/items/product', {
                                params: {
                                    filter: { name: { _eq: row.name } },
                                    fields: ['id'],
                                    limit: 1
                                }
                            });
                            const existingId = existingRes.data.data[0]?.id;

                            const thumbId = await getFileId(row.thumbnail);
                            const illusPayload = [];
                            if (row.illustrations) {
                                for (const src of row.illustrations.split(',')) {
                                    const fid = await getFileId(src.trim());
                                    if (fid) illusPayload.push({ directus_files_id: { id: fid } });
                                }
                            }

                            const payload = {
                                status: row.status || 'active',
                                name: row.name,
                                brand_name: row.brand_name,
                                price: parseFloat(row.price || 0),
                                quantity: row.quantity,
                                description: formatDescription(row.description),
                                suitable_skin_type: mapSkinType(row.skin_types),
                                categories: await getCategoryPayload(row.categories),
                                thumbnail: thumbId,
                                illustration: illusPayload,
                                temp_ingredients: row.ingredients
                            };

                            if (existingId) {
                                await api.patch(`/items/product/${existingId}`, payload);
                                addLog(`‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${row.name}`, 'success');
                            } else {
                                await api.post('/items/product', payload);
                                addLog(`‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${row.name}`, 'success');
                            }
                        } catch (err) { 
                            addLog(`‚ùå ‡∏û‡∏•‡∏≤‡∏î: ${row.name} (${err.message})`, 'error'); 
                        }
                    }
                    isProcessing.value = false;
                    addLog('--- ‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ---');
                }
            });
        };

        return { csvFile, localImages, isProcessing, showGuide, logs, logContainer, onCSVSelect, onImagesSelect, startImport, downloadTemplate };
    }
};
</script>

<style scoped>
.import-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 32px;
    padding: 32px;
    height: 100%;
    background-color: var(--background-subdued);
    align-items: start;
    user-select: text !important;
}

.log-panel {
    height: 550px;
}

.console-box {
    height: 100%;
    background: #1a1c1e;
    border-radius: 16px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    border: 1px solid #2d2f31;
}

.guide-dialog-card {
    min-width: 1200px;
    max-height: 85vh;
    display: flex;
    flex-direction: column;
}

.scrollable-content {
    overflow-y: auto;
    flex: 1;
    padding: 24px;
    user-select: text !important;
}

.console-content,
.guide-table,
.cheat-table,
code,
td,
th,
.m,
.t {
    user-select: text !important;
    cursor: text;
}

.download-card {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 14px 18px;
    background-color: var(--background-subdued);
    border: 1px solid var(--border-normal);
    border-radius: var(--border-radius);
    cursor: pointer;
    transition: all 0.2s ease-in-out;
    width: 400px;
}

.download-card:hover {
    border-color: var(--primary);
    background-color: var(--primary-5);
}

.download-icon-box {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    color: var(--primary);
    background: var(--primary-10);
    border-radius: 8px;
}

.download-info {
    display: flex;
    flex-direction: column;
}

.main-text {
    font-weight: 600;
    font-size: 14px;
    color: var(--foreground-normal);
}

.sub-text {
    font-size: 12px;
    color: var(--foreground-subdued);
    margin-top: 2px;
}

.main-card {
    padding: 32px;
    border-radius: 16px;
    border: 1px solid var(--border-normal);
    background: var(--background-normal);
}

.card-header {
    text-align: center;
    margin-bottom: 8px;
}

.card-header h2 {
    font-size: 24px;
    font-weight: 700;
    margin-top: 12px;
}

.step-section {
    display: flex;
    gap: 16px;
    align-items: flex-start;
}

.step-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 2px;
}

.step-badge {
    width: 24px;
    height: 24px;
    font-size: 12px;
    background: var(--primary-10);
    color: var(--primary);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    flex-shrink: 0;
}

.step-title {
    font-weight: 700;
    font-size: 15px;
    color: var(--foreground-normal);
}

.drop-label {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
    border: 2px dashed var(--border-normal);
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 13px;
    font-weight: 600;
    color: var(--foreground-subdued);
    width: 400px;
}

.drop-label:hover {
    border-color: var(--primary);
    background: var(--primary-5);
}

.drop-label.has-file {
    border-style: solid;
    border-color: var(--green);
    background: var(--green-5);
    color: var(--green);
}

.console-header {
    background: #252729;
    padding: 12px 20px;
    border-bottom: 1px solid #36393c;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.console-content {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
    font-family: monospace;
    font-size: 12px;
    color: #e1e3e5;
    line-height: 1.6;
}

.log-entry {
    margin-bottom: 6px;
    display: flex;
    gap: 10px;
}

.log-entry.success .m {
    color: #98c379;
}

.log-entry.error .m {
    color: #e06c75;
}

.t {
    color: #5c6370;
}

.guide-table {
    width: 100%;
    border-collapse: collapse;
}

.guide-table th,
.guide-table td {
    padding: 12px;
    border: 1px solid var(--border-normal);
    text-align: left;
    font-size: 13px;
}

.guide-table th {
    background: var(--background-subdued);
    position: sticky;
    top: 0;
    z-index: 10;
}

.html-cheat-sheet {
    background: #f0f4f9;
    padding: 20px;
    border-radius: 12px;
    border: 1px solid #d1d9e2;
}

.cheat-table {
    width: 100%;
    background: #ffffff;
    border-collapse: collapse;
    border-radius: 8px;
    overflow: hidden;
}

.cheat-table th,
.cheat-table td {
    padding: 12px 16px;
    border: 1px solid #e2e8f0;
    font-size: 13px;
}

.cheat-table code {
    background: #fff5f5;
    color: #c53030;
    padding: 2px 6px;
    border-radius: 4px;
    font-family: monospace;
    font-weight: bold;
}

.hidden {
    display: none;
}

.my-24 {
    margin: 24px 0;
}

.mt-12 {
    margin-top: 12px;
}

.mb-24 {
    margin-bottom: 24px;
}
</style>